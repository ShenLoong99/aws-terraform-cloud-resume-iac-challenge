name: "Production Deployment"
on:
  push:
    branches: [ main ]
    paths:
      - "**.tf"
      - "lambda/**"
      - "website-files/**"
      - ".github/workflows/cd.yml"
  workflow_dispatch:

jobs:
  # Detect what changed to optimize the run
  changes:
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      app: ${{ steps.filter.outputs.app }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infra:
              - '**.tf'
              - 'lambda/**'
            app:
              - 'website-files/**'
              - '.github/workflows/cd.yml'

  # Infrastructure Job (Terraform)
  terraform:
    needs: changes
    # Only run if .tf files or lambda code changed
    if: needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        run: terraform apply -auto-approve

  # Deployment & Health Check (Frontend & Testing)
  deploy:
    needs: [changes, terraform]
    # Run if the app (frontend) changed OR the infra job finished successfully
    if: |
      always() && 
      (needs.changes.outputs.app == 'true' || needs.terraform.result == 'success')
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Set Environment Variables
        run: |
          echo "API_URL=$(terraform output -raw api_url)" >> $GITHUB_ENV
          echo "SITE_URL=$(terraform output -raw website_url)" >> $GITHUB_ENV
          echo "BUCKET_NAME=$(terraform output -raw website_bucket_id)" >> $GITHUB_ENV
          echo "DIST_ID=$(terraform output -raw cloudfront_dist_id)" >> $GITHUB_ENV
          echo "AWS_REGION=$(terraform output -raw aws_region)" >> $GITHUB_ENV

      - name: Inject into HTML
        run: |
          GITHUB_USER="${{ github.repository_owner }}"
          LINKEDIN=$(curl -s https://api.github.com/users/$GITHUB_USER/social_accounts | jq -r '.[] | select(.url | contains("linkedin.com")) | .url')
          
          sed -i "s|__API_URL__|$API_URL|g" ./website-files/index.html
          sed -i "s|__GITHUB_REPO__|${{ github.server_url }}/${{ github.repository }}|g" ./website-files/index.html
          sed -i "s|__LINKEDIN_URL__|$LINKEDIN|g" ./website-files/index.html
          sed -i "s|__EMAIL__|${{ secrets.EMAIL_ADDRESS }}|g" ./website-files/index.html

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::871308866502:role/GitHubActionRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy and Invalidate
        run: |
          aws s3 sync ./website-files s3://${{ env.BUCKET_NAME }} --delete
          aws cloudfront create-invalidation --distribution-id ${{ env.DIST_ID }} --paths "/*"

      - name: Smoke Test Website
        run: |
          chmod +x ./scripts/smoke-test-website.sh
          ./scripts/smoke-test-website.sh
        env:
          SITE_URL: ${{ env.SITE_URL }}

      - name: Test Visitor Counter API
        run: |
          chmod +x ./scripts/test-visitor-counter.sh
          ./scripts/test-visitor-counter.sh
        env:
          API_URL: ${{ env.API_URL }}