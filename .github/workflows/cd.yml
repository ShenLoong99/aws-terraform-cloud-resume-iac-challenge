name: "Production Deployment"
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false # Recommended for cleaner script output
      
      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        # With TFC 'Auto-apply' enabled in the UI, this triggers the deploy immediately
        run: terraform apply -auto-approve

      - name: Set Environment Variables from Terraform
        run: |
          # Capture dynamic values from your outputs.tf 
          API_URL=$(terraform output -raw api_url)
          BUCKET_ID=$(terraform output -raw website_bucket_id)
          DIST_ID=$(terraform output -raw cloudfront_dist_id)
          
          # Capture social/repo links from your outputs.tf 
          GIT_REPO=$(terraform output -raw github_repo)
          GIT_PROF=$(terraform output -raw github_profile)
          LINKEDIN=$(terraform output -raw linkedin)
          EMAIL=$(terraform output -raw email_address)

          # Use 'sed' to inject values into placeholders
          # We use | as a delimiter because URLs contain slashes (/)
          sed -i "s|__API_URL__|$API_URL|g" ./website-files/index.html
          sed -i "s|__GITHUB_REPO__|$GIT_REPO|g" ./website-files/index.html
          sed -i "s|__GITHUB_PROFILE__|$GIT_PROF|g" ./website-files/index.html
          sed -i "s|__LINKEDIN__|$LINKEDIN|g" ./website-files/index.html
          sed -i "s|__EMAIL__|$EMAIL|g" ./website-files/index.html

          # Save AWS IDs to the environment for later steps
          echo "BUCKET_NAME=$BUCKET_ID" >> $GITHUB_ENV
          echo "DIST_ID=$DIST_ID" >> $GITHUB_ENV
          echo "SITE_URL=$API_URL" >> $GITHUB_ENV

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::871308866502:role/GitHubActionRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: aws s3 sync ./website-files s3://${{ env.BUCKET_NAME }} --delete

      - name: Invalidate CloudFront
        run: aws cloudfront create-invalidation --distribution-id ${{ env.DIST_ID }} --paths "/*"

      - name: Smoke Test Website
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" ${{ env.SITE_URL }})
          if [ $STATUS -ne 200 ]; then
            echo "❌ Website is down! Status: $STATUS"
            exit 1
          fi
          echo "✅ Website is live at ${{ env.SITE_URL }}"

      - name: Test Visitor Counter API
        run: |
          # 1. Fetch current count
          COUNT1=$(curl -s "${{ env.SITE_URL }}/api/getcount" | jq '.count')
          
          # 2. Wait a second and fetch again
          sleep 1
          COUNT2=$(curl -s "${{ env.SITE_URL }}/api/getcount" | jq '.count')
          
          # 3. Verify the count increased
          if [ "$COUNT2" -gt "$COUNT1" ]; then
            echo "✅ Counter is working: $COUNT1 -> $COUNT2"
          else
            echo "❌ Counter failed to increment!"
            exit 1
          fi